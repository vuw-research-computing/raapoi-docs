<!DOCTYPE html>

<html class="writer-html5" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/><link href="https://vuw-research-computing.github.io/raapoi-docs/advanced/OpenMPI_users_guide/" rel="canonical"/>
<link href="../../img/favicon.ico" rel="shortcut icon"/>
<title>OpenMPI users guide - Rāpoi Cluster Documentation</title>
<link href="../../css/theme.css" rel="stylesheet"/>
<link href="../../css/theme_extra.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/>
<link href="../../extra.css" rel="stylesheet"/>
<link href="../../css/neoteroi-mkdocs.css" rel="stylesheet"/>
<script>
        // Current page data
        var mkdocs_page_name = "OpenMPI users guide";
        var mkdocs_page_input_path = "advanced/OpenMPI_users_guide.md";
        var mkdocs_page_url = "/raapoi-docs/advanced/OpenMPI_users_guide/";
      </script>
<!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body class="wy-body-for-nav" role="document">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side stickynav" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../.."> Rāpoi Cluster Documentation
        </a><div role="search">
<form action="../../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" title="Type search term here" type="text"/>
</form>
</div>
</div>
<div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<ul>
<li class="toctree-l1"><a class="reference internal" href="../..">Overview</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../accessing_the_cluster/">Accessing the Cluster</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../basic_commands/">Basic Commands</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../storage/">Storage and Quotas</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../partitions/">Using Partitions</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../environment/">Preparing your Environment (modules)</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../new_mod/">New module system</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../running_jobs/">Running Jobs</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../managing_jobs/">Managing Jobs</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/">Examples and User Guides</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../parallel_processing/">Parallel Processing</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_examples/">Advanced Examples</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../training/">Training</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../external_providers/">Connecting to Cloud/Storage Providers</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../usersub/">User Submitted Docs</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/">FAQ</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../elements/LinkingElements/">Linking Rāpoi outputs to Elements</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../hpclayout/">HPC Hardware Layout</a>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../support/">Support</a>
</li>
</ul>
<p class="caption"><span class="caption-text">Moderators Section</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mods_admins/">Notes for Moderators</a>
</li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift">
<nav aria-label="Mobile navigation menu" class="wy-nav-top" role="navigation">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../..">Rāpoi Cluster Documentation</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content"><div aria-label="breadcrumbs navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Docs" class="icon icon-home" href="../.."></a></li>
<li class="breadcrumb-item active">OpenMPI users guide</li>
<li class="wy-breadcrumbs-aside">
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div class="section" itemprop="articleBody">
<h2 id="openmpi-users-guide">OpenMPI users guide<a class="headerlink" href="#openmpi-users-guide" title="Permanent link">¶</a></h2>
<h3 id="which-versions-of-openmpi-are-working-on-rapoi">Which versions of OpenMPI are working on Rāpoi?<a class="headerlink" href="#which-versions-of-openmpi-are-working-on-rapoi" title="Permanent link">¶</a></h3>
<p>There are a number of versions of OpenMPI on Rāpoi, although many of these are old installations (prior to an OS update and changes to the module system) and <em>may</em> no longer work.
Generally speaking, your best bet is to try a version which appears when you search via <code>module spider OpenMPI</code> (noting that the capital 'O M P I' is important here).
A few examples of relatively recent version of OpenMPI which are available (as of April 2024) are <code>OpenMPI/4.1.1</code>, <code>OpenMPI/4.1.4</code> and <code>OpenMPI/4.1.6</code>.</p>
<p>Each of these OpenMPI modules has one or more of pre-requisite modules that need to be loaded first (generally a specific version of GCC compilers).
To find out what you need to load first for a specific version of OpenMPI you just need to check the output of <code>module spider OpenMPI/x.y.z</code> (with the appropriate values for x,y,z).
One of the examples below shows how to use <code>OpenMPI/4.1.6</code>.
In cases where your code utilises software from another module which also requires a specific GCC module, that will dictate which version of OpenMPI to load (i.e. whichever one depends on the same GCC version).
Otherwise, you are free to use any desired OpenMPI module. </p>
<h3 id="known-issues-and-workarounds">Known issues and workarounds<a class="headerlink" href="#known-issues-and-workarounds" title="Permanent link">¶</a></h3>
<p>There is a known issue with the communication/networking interfaces with several of the installations of OpenMPI. 
The error/warning messages occur sporadically, making it difficult to pin down and resolve, but it is likely there is a combination of internal and external factors that cause this (OpenMPI is a very complex beast).
The warning messages take the form:
<div class="highlight"><pre><span></span><code><span id="__span-0-1"><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>Failed to modify UD QP to INIT on mlx5_0: Operation not permitted
</span></code></pre></div>
A workaround is described below, this page will be updated in the future when a more permanent solution is found.</p>
<p>Exectute your mpi jobs using the additional arguments:
<div class="highlight"><pre><span></span><code><span id="__span-1-1"><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a>mpirun<span class="w"> </span>-mca<span class="w"> </span>pml<span class="w"> </span>ucx<span class="w"> </span>-mca<span class="w"> </span>btl<span class="w"> </span><span class="s1">'^uct,ofi'</span><span class="w"> </span>-mca<span class="w"> </span>mtl<span class="w"> </span><span class="s1">'^ofi'</span><span class="w"> </span>-np<span class="w"> </span><span class="nv">$SLURM_NTASKS</span><span class="w"> </span>&lt;your<span class="w"> </span>executable&gt;
</span></code></pre></div>
This will ensure OpenMPI avoids trying to use the communication libraries which are problematic.
If your executable is launched without using mpirun (i.e. it implements its own wrapper/launcher), you will instead need to set the following environment variables:
<div class="highlight"><pre><span></span><code><span id="__span-2-1"><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OMPI_MCA_btl</span><span class="o">=</span><span class="s1">'^uct,ofi'</span>
</span><span id="__span-2-2"><a href="#__codelineno-2-2" id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OMPI_MCA_pml</span><span class="o">=</span><span class="s1">'ucx'</span>
</span><span id="__span-2-3"><a href="#__codelineno-2-3" id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">OMPI_MCA_mtl</span><span class="o">=</span><span class="s1">'^ofi'</span>
</span></code></pre></div></p>
<p>Software module ORCA users, sometimes, come across an error message: 
<div class="highlight"><pre><span></span><code><span id="__span-3-1"><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a>PML<span class="w"> </span>ucx<span class="w"> </span>cannot<span class="w"> </span>be<span class="w"> </span>selected
</span></code></pre></div>
To address this, update mpirun variables to: 
<div class="highlight"><pre><span></span><code><span id="__span-4-1"><a href="#__codelineno-4-1" id="__codelineno-4-1" name="__codelineno-4-1"></a>mpirun<span class="w"> </span>--mca<span class="w"> </span>btl<span class="w"> </span>^openib<span class="w"> </span>--mca<span class="w"> </span>pml<span class="w"> </span>ob1<span class="w"> </span>--mca<span class="w"> </span>osc<span class="w"> </span>ucx<span class="w"> </span>-np<span class="w"> </span>...&lt;remaining<span class="w"> </span>params&gt;<span class="sb">`</span>
</span></code></pre></div></p>
</div>
</div><footer>
<hr/>
<div role="contentinfo">
<!-- Copyright etc -->
</div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
</span>
</div>
<script src="../../js/jquery-3.6.0.min.js"></script>
<script>var base_url = "../..";</script>
<script src="../../js/theme_extra.js"></script>
<script src="../../js/theme.js"></script>
<script src="https://unpkg.com/mermaid@8.7.0/dist/mermaid.min.js"></script>
<script src="https://vuw-research-computing.statuspage.io/embed/script.js"></script>
<script src="../../search/main.js"></script>
<script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>
</body>
</html>
